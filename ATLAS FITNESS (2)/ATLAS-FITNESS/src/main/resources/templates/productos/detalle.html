<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="base :: head('Detalle del Producto', ~{}, ~{})">
    <style>
        .product-gallery {
            position: relative;
        }
        
        .product-main-img {
            border-radius: 10px;
            transition: transform 0.3s;
        }
        
        .product-main-img:hover {
            transform: scale(1.02);
        }
        
        .product-thumbnails {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .product-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: #FFD700;
        }
        
        .stock-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .quantity-control {
            max-width: 150px;
        }
        
        .product-features {
            list-style: none;
            padding: 0;
        }
        
        .product-features li {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .product-features li:last-child {
            border-bottom: none;
        }
        
        .product-features li i {
            color: #FFD700;
            margin-right: 10px;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header th:replace="base :: header"></header>

    <!-- Contenido Principal -->
    <main class="container py-5">
        <!-- Mensajes -->
        <div th:if="${#request.getParameter('success') != null}" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${#request.getParameter('success')}">Producto agregado al carrito</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${#request.getParameter('error') != null}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${#request.getParameter('error')}">Error al agregar producto</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- Navegación -->
            <div class="col-12 mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent">
                        <li class="breadcrumb-item">
                            <a th:href="@{/}" class="text-gold text-decoration-none">
                                <i class="bi bi-house-door"></i> Inicio
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{/productos}" class="text-gold text-decoration-none">
                                Productos
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a th:href="@{'/productos?categoria=' + ${producto.categoria.name}}" 
                               class="text-gold text-decoration-none"
                               th:text="${producto.categoria}">
                                Categoría
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-white" th:text="${producto.nombre}" aria-current="page">
                            Producto
                        </li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <!-- Imagen del producto -->
            <div class="col-md-6 mb-4">
                <div class="product-gallery bg-dark rounded p-4 border-gold">
                    <img th:src="@{'/images/' + (producto.imagenUrl != null ? producto.imagenUrl : 'default-product.png')}" 
                         class="product-main-img img-fluid w-100" 
                         th:alt="${producto.nombre}"
                         id="main-product-img"
                         onerror="this.src='/images/default-product.png'">
                    
                    <!-- Thumbnails -->
                    <div class="product-thumbnails">
                        <img th:src="@{'/images/' + (producto.imagenUrl != null ? producto.imagenUrl : 'default-product.png')}" 
                             class="product-thumbnail active" 
                             th:alt="${producto.nombre}"
                             onclick="changeMainImage(this.src)">
                    </div>
                </div>
            </div>
            
            <!-- Información del producto -->
            <div class="col-md-6 mb-4">
                <div class="bg-dark rounded p-4 border-gold h-100">
                    <!-- Categoría y estado -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge bg-gold text-black" th:text="${producto.categoria}">
                            SUPLEMENTO
                        </span>
                        
                        <span th:if="${producto.estaDisponible()}" 
                              class="stock-badge bg-success text-white">
                            <i class="bi bi-check-circle me-1"></i> En stock
                        </span>
                        <span th:unless="${producto.estaDisponible()}" 
                              class="stock-badge bg-danger text-white">
                            <i class="bi bi-x-circle me-1"></i> Agotado
                        </span>
                    </div>
                    
                    <!-- Nombre del producto -->
                    <h1 class="text-white mb-3" th:text="${producto.nombre}">Proteína Whey Gold</h1>
                    
                    <!-- Precio -->
                    <div class="mb-4">
                        <h2 class="text-gold" th:text="'S/ ' + ${#numbers.formatDecimal(producto.precio, 1, 2)}">
                            S/ 120.00
                        </h2>
                        <p class="text-white-50 mb-0">
                            <small>Precio por unidad</small>
                        </p>
                    </div>
                    
                    <!-- Descripción -->
                    <div class="mb-4">
                        <h5 class="text-white mb-3">
                            <i class="bi bi-info-circle text-gold me-2"></i>Descripción
                        </h5>
                        <p class="text-white-50" th:text="${producto.descripcion ?: 'Sin descripción disponible'}">
                            Proteína de suero de leche de alta calidad para recuperación muscular.
                        </p>
                    </div>
                    
                    <!-- Características -->
                    <div class="mb-4">
                        <h5 class="text-white mb-3">
                            <i class="bi bi-list-check text-gold me-2"></i>Características
                        </h5>
                        <ul class="product-features text-white-50">
                            <li>
                                <i class="bi bi-check-circle"></i>
                                <span th:if="${producto.marca != null}" th:text="'Marca: ' + ${producto.marca}">
                                    Marca: Idealía
                                </span>
                                <span th:unless="${producto.marca != null}">Marca: No especificada</span>
                            </li>
                            <li>
                                <i class="bi bi-check-circle"></i>
                                <span th:if="${producto.subcategoria != null}" 
                                      th:text="'Tipo: ' + ${producto.subcategoria}">
                                    Tipo: Whey Protein
                                </span>
                                <span th:unless="${producto.subcategoria != null}">Tipo: General</span>
                            </li>
                            <li>
                                <i class="bi bi-check-circle"></i>
                                <span th:text="'Stock disponible: ' + ${producto.stock}">
                                    Stock disponible: 50 unidades
                                </span>
                            </li>
                            <li>
                                <i class="bi bi-check-circle"></i>
                                <span>Envío gratis en compras mayores a S/ 200</span>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Formulario para agregar al carrito -->
                    <div th:if="${producto.estaDisponible()}">
                        <form th:action="@{/carrito/agregar}" method="post" id="add-to-cart-form">
                            <input type="hidden" name="productoId" th:value="${producto.idProducto}">
                            <input type="hidden" name="redirect" value="detalle">
                            <input type="hidden" id="hidden-producto-id" th:value="${producto.idProducto}">
                            
                            <div class="row align-items-center">
                                <div class="col-md-5 mb-3">
                                    <label for="cantidad" class="form-label text-white">Cantidad:</label>
                                    <div class="input-group quantity-control">
                                        <button class="btn btn-outline-gold" type="button" 
                                                id="decrease-btn">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" 
                                               name="cantidad" 
                                               id="cantidad"
                                               class="form-control bg-dark text-white border-gold text-center" 
                                               value="1" 
                                               min="1" 
                                               th:max="${producto.stock}"
                                               th:attr="data-max-stock=${producto.stock}">
                                        <button class="btn btn-outline-gold" type="button" 
                                                id="increase-btn">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <small class="text-white-50 d-block mt-1">
                                        Máximo: <span id="max-stock-display" th:text="${producto.stock}">50</span> unidades
                                    </small>
                                </div>
                                <div class="col-md-7 mb-3">
                                    <button type="submit" 
                                            class="btn btn-gold btn-lg w-100 py-3"
                                            id="add-to-cart-btn">
                                        <i class="bi bi-cart-plus me-2"></i>Agregar al Carrito
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Compra rápida -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-gold w-100" 
                                    id="comprar-ahora-btn"
                                    th:if="${session.usuario != null}">
                                <i class="bi bi-lightning-charge me-2"></i>Comprar ahora
                            </button>
                            <a th:href="@{/auth/login}" 
                               class="btn btn-outline-gold w-100"
                               th:unless="${session.usuario != null}">
                                <i class="bi bi-lightning-charge me-2"></i>Iniciar sesión para comprar
                            </a>
                        </div>
                    </div>
                    
                    <!-- Producto agotado -->
                    <div th:unless="${producto.estaDisponible()}" class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Este producto está actualmente agotado. 
                        <a th:href="@{/contacto}" class="alert-link text-dark">Contáctanos</a> para saber cuándo estará disponible.
                    </div>
                    
                    <!-- Botones adicionales -->
                    <div class="mt-4 pt-3 border-top border-secondary">
                        <div class="row">
                            <div class="col-6">
                                <a th:href="@{/productos}" class="btn btn-outline-gold w-100">
                                    <i class="bi bi-arrow-left me-1"></i>Volver
                                </a>
                            </div>
                            <div class="col-6">
                                <a th:href="@{/carrito}" class="btn btn-outline-gold w-100">
                                    <i class="bi bi-cart3 me-1"></i>Ver Carrito
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos relacionados -->
        <div class="row mt-5" th:if="${relacionados != null and !relacionados.isEmpty()}">
            <div class="col-12">
                <h3 class="text-gold mb-4">
                    <i class="bi bi-grid-3x3-gap text-gold me-2"></i>
                    Productos Relacionados
                </h3>
                <div class="row g-4">
                    <div class="col-md-3" th:each="relacionado : ${relacionados}">
                        <div class="card card-gym product-card h-100">
                            <img th:src="@{'/images/' + (relacionado.imagenUrl != null ? relacionado.imagenUrl : 'default-product.png')}" 
                                 class="product-img card-img-top" 
                                 th:alt="${relacionado.nombre}" 
                                 style="height: 150px; object-fit: cover;"
                                 onerror="this.src='/images/default-product.png'">
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title text-white mb-2" th:text="${relacionado.nombre}">Producto</h6>
                                <p class="text-gold fw-bold mb-2" 
                                   th:text="'S/ ' + ${#numbers.formatDecimal(relacionado.precio, 1, 2)}">
                                    S/ 120.00
                                </p>
                                <a th:href="@{/productos/{id}(id=${relacionado.idProducto})}" 
                                   class="btn btn-outline-gold btn-sm mt-auto">
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="base :: footer"></footer>

    <!-- Scripts -->
    <script>
        // ============================================
        // FUNCIONES BÁSICAS
        // ============================================
        
        // Cambiar imagen principal
        function changeMainImage(src) {
            const mainImg = document.getElementById('main-product-img');
            if (mainImg) {
                mainImg.src = src;
            }
            
            // Actualizar thumbnails activos
            document.querySelectorAll('.product-thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // ============================================
        // CONTROL DE CANTIDAD
        // ============================================
        
        function initializeQuantityControl() {
            const cantidadInput = document.getElementById('cantidad');
            const decreaseBtn = document.getElementById('decrease-btn');
            const increaseBtn = document.getElementById('increase-btn');
            
            if (!cantidadInput || !decreaseBtn || !increaseBtn) return;
            
            // Obtener stock máximo
            const maxStock = parseInt(cantidadInput.getAttribute('data-max-stock') || 
                                     document.getElementById('max-stock-display')?.textContent || 999);
            
            // Actualizar estado de botones
            function updateButtons() {
                const currentValue = parseInt(cantidadInput.value) || 1;
                decreaseBtn.disabled = currentValue <= 1;
                increaseBtn.disabled = currentValue >= maxStock;
                
                // Aplicar clases visuales
                if (decreaseBtn.disabled) {
                    decreaseBtn.classList.add('btn-disabled');
                } else {
                    decreaseBtn.classList.remove('btn-disabled');
                }
                
                if (increaseBtn.disabled) {
                    increaseBtn.classList.add('btn-disabled');
                } else {
                    increaseBtn.classList.remove('btn-disabled');
                }
            }
            
            // Disminuir cantidad
            decreaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(cantidadInput.value) || 1;
                if (currentValue > 1) {
                    cantidadInput.value = currentValue - 1;
                    updateButtons();
                }
            });
            
            // Aumentar cantidad
            increaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(cantidadInput.value) || 1;
                if (currentValue < maxStock) {
                    cantidadInput.value = currentValue + 1;
                    updateButtons();
                }
            });
            
            // Validar input manual
            cantidadInput.addEventListener('change', function() {
                let value = parseInt(this.value) || 1;
                if (value < 1) {
                    this.value = 1;
                } else if (value > maxStock) {
                    this.value = maxStock;
                }
                updateButtons();
            });
            
            // Validar mientras se escribe
            cantidadInput.addEventListener('input', function() {
                let value = parseInt(this.value);
                if (!isNaN(value) && value > maxStock) {
                    this.value = maxStock;
                }
            });
            
            // Inicializar
            updateButtons();
        }
        
        // ============================================
        // AGREGAR AL CARRITO
        // ============================================
        
        function initializeAddToCart() {
            const addToCartForm = document.getElementById('add-to-cart-form');
            if (!addToCartForm) return;
            
            addToCartForm.addEventListener('submit', function(e) {
                const button = document.getElementById('add-to-cart-btn');
                if (button) {
                    // Guardar texto original
                    const originalText = button.innerHTML;
                    const originalClass = button.className;
                    
                    // Mostrar estado de carga
                    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Agregando...';
                    button.classList.remove('btn-gold');
                    button.classList.add('btn-secondary');
                    button.disabled = true;
                    
                    // Restaurar después de 3 segundos (por si hay error)
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.className = originalClass;
                        button.disabled = false;
                    }, 3000);
                }
            });
        }
        
        // ============================================
        // COMPRAR AHORA
        // ============================================
        
        function initializeBuyNow() {
            const comprarAhoraBtn = document.getElementById('comprar-ahora-btn');
            if (!comprarAhoraBtn) return;
            
            comprarAhoraBtn.addEventListener('click', function() {
                // Obtener datos del producto
                const productoIdInput = document.getElementById('hidden-producto-id');
                const cantidadInput = document.getElementById('cantidad');
                
                if (!productoIdInput || !cantidadInput) {
                    alert('Error: No se pudo obtener la información del producto');
                    return;
                }
                
                const productoId = productoIdInput.value;
                const cantidad = cantidadInput.value || 1;
                
                // Mostrar confirmación
                if (confirm(`¿Comprar ${cantidad} unidad(es) de este producto ahora?`)) {
                    // Crear formulario para compra directa
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/carrito/comprar-ahora'; // Necesitarás crear este endpoint
                    
                    // Agregar campos
                    const productoIdField = document.createElement('input');
                    productoIdField.type = 'hidden';
                    productoIdField.name = 'productoId';
                    productoIdField.value = productoId;
                    form.appendChild(productoIdField);
                    
                    const cantidadField = document.createElement('input');
                    cantidadField.type = 'hidden';
                    cantidadField.name = 'cantidad';
                    cantidadField.value = cantidad;
                    form.appendChild(cantidadField);
                    
                    const redirectField = document.createElement('input');
                    redirectField.type = 'hidden';
                    redirectField.name = 'redirect';
                    redirectField.value = 'checkout';
                    form.appendChild(redirectField);
                    
                    // Agregar token CSRF si existe
                    const csrfToken = document.querySelector('input[name="_csrf"]');
                    if (csrfToken) {
                        const csrfClone = csrfToken.cloneNode(true);
                        csrfClone.style.display = 'none';
                        form.appendChild(csrfClone);
                    }
                    
                    // Enviar formulario
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }
        
        // ============================================
        // MANEJO DE LOGIN
        // ============================================
        
        function initializeLoginRedirect() {
            const loginButtons = document.querySelectorAll('a[href*="/auth/login"]');
            loginButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    // Guardar URL actual para redirigir después del login
                    const currentUrl = window.location.href;
                    localStorage.setItem('redirectAfterLogin', currentUrl);
                });
            });
        }
        
        // ============================================
        // MANEJO DE MENSAJES
        // ============================================
        
        function showMessage(type, text) {
            // Crear elemento de mensaje
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            messageDiv.innerHTML = `
                <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-2"></i>
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insertar después del primer elemento del main
            const main = document.querySelector('main .container');
            if (main && main.firstChild) {
                main.insertBefore(messageDiv, main.children[1]);
            }
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    const bsAlert = new bootstrap.Alert(messageDiv);
                    bsAlert.close();
                }
            }, 5000);
        }
        
        function checkUrlForMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');
            
            if (success) {
                showMessage('success', decodeURIComponent(success));
            }
            
            if (error) {
                showMessage('danger', decodeURIComponent(error));
            }
        }
        
        // ============================================
        // INICIALIZACIÓN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar controles
            initializeQuantityControl();
            initializeAddToCart();
            initializeBuyNow();
            initializeLoginRedirect();
            
            // Verificar mensajes en la URL
            checkUrlForMessages();
            
            // Configurar imágenes con fallback
            const images = document.querySelectorAll('img[onerror]');
            images.forEach(img => {
                img.addEventListener('error', function() {
                    if (this.src !== '/images/default-product.png') {
                        this.src = '/images/default-product.png';
                    }
                });
            });
        });
        
        // ============================================
        // FUNCIONES DE AYUDA
        // ============================================
        
        // Validar que un número esté en rango
        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }
        
        // Formatear precio
        function formatPrice(price) {
            return 'S/ ' + parseFloat(price).toFixed(2);
        }
    </script>
</body>
</html>